{% extends "base.html" %}

{% block content %}
<h2 class="mb-4 text-center">ðŸ“¦ Medicine Inventory</h2>

<div class="text-end mb-3">
    <a href="{{ url_for('add_medicine') }}" class="btn btn-primary">
        + Add New Medicine
    </a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="card shadow">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Batch</th>
                        <th>Expiry Date</th>
                        <th>Quantity</th>
                        <th>Buy Price</th>
                        <th>Sell Price</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if medicines %}
                        {% for med in medicines %}
                            {% set is_expired = med.expiry and med.expiry < today %}
                            {% set days_left = (med.expiry|date_diff(today)) if med.expiry else none %}
                            {% set expiring_soon = med.expiry and not is_expired and days_left <= 30 %}

                            <tr {% if is_expired %}
                                    class="table-danger"
                                {% elif expiring_soon %}
                                    class="table-warning"
                                {% elif med.quantity < low_threshold %}
                                    class="table-danger"
                                {% endif %}>
                                <td>{{ med.id }}</td>
                                <td><strong>{{ med.name }}</strong></td>
                                <td>{{ med.batch or "-" }}</td>
                                <td>
                                    {{ med.expiry or "No expiry date" }}
                                    {% if is_expired %}
                                        <span class="badge bg-danger ms-2">Expired!</span>
                                    {% elif expiring_soon %}
                                        <span class="badge bg-warning text-dark ms-2">Expiring Soon ({{ days_left }} days)</span>
                                    {% endif %}
                                </td>
                                <td {% if med.quantity < low_threshold %}class="fw-bold text-danger"{% endif %}>
                                    {{ med.quantity }}
                                    {% if med.quantity < low_threshold %}
                                        <span class="text-danger">(Low Stock!)</span>
                                    {% endif %}
                                </td>
                                <td>{{ CURRENCY_SYMBOL }} {{ "%.2f"|format(med.buy_price) }}</td>
                                <td>{{ CURRENCY_SYMBOL }} {{ "%.2f"|format(med.sell_price) }}</td>
                                <td class="text-center">
                                    <a href="{{ url_for('edit_medicine', id=med.id) }}" class="btn btn-warning btn-sm">Edit</a>
                                    <a href="{{ url_for('delete_medicine', id=med.id) }}" 
                                       class="btn btn-danger btn-sm ms-1"
                                       onclick="return confirm('Delete {{ med.name }}?')">
                                        Delete
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}

                        <!-- Totals Row -->
                        <tr class="table-primary fw-bold">
                            <td colspan="5" class="text-end pe-4">INVENTORY TOTALS:</td>
                            <td class="text-end">{{ CURRENCY_SYMBOL }} {{ "%.2f"|format(total_buy) }}</td>
                            <td class="text-end">{{ CURRENCY_SYMBOL }} {{ "%.2f"|format(total_sell) }}</td>
                            <td class="text-center text-success">{{ CURRENCY_SYMBOL }} {{ "%.2f"|format(total_profit) }}</td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                <h5>No medicines in inventory yet.</h5>
                                <p>Click "+ Add New Medicine" to get started!</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Quick Links -->
<div class="text-center mt-4">
    <a href="{{ url_for('sales') }}" class="btn btn-success btn-lg">Go to Sales</a>
    <a href="{{ url_for('low_stock_report') }}" class="btn btn-outline-warning btn-lg ms-2">Low Stock Report</a>
    <a href="{{ url_for('expired_report') }}" class="btn btn-outline-danger btn-lg ms-2">Expired Report</a>
</div>
{% endblock %}